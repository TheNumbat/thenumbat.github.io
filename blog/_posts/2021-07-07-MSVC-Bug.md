---
layout: post
title: An Odd MSVC Bug
draft: true
---

# TODO
#     get bad assembly from old msvc version 
#     compare with assembly from fixed version 

While I was working on [Dawn](/projects/dawn) in 2019, I ran into a curious bug in the Visual Studio 2019 C++ compiler. I reported it to the bug tracker, where it was quickly confirmed to be an interference analysis issue and finally fixed in 2021. However, I still have little idea what caused the issue in the first place.

The problem arose when I was implementing a Perlin noise type for procedural solid texturing. My type just so happened to include a 4-kilobyte array of pre-initialized random data, and this precise size caused writes to the data to interfere with a proceeding struct member. This ended up bricking the output of my path tracer&mdash;but only with optimizations enabled!

Assuming by default that there was some bug in my code, I was able to narrow down the problem to an unintended Perlin noise data update. But, I simply could not figure out why the write ocurred when it did&mdash;there wasn't even any applicable undefined behavior. I started stripping out pieces of my code until I could minimally reproduce the issue. Still baffled, I checked if my result worked properly in GCC and Clang, and it did: my issue was a rare broken-codegen compiler bug. 

I was able to capture the issue in the following example:
```c++
#include <cstdint>
#include <cstdio>

struct data {
	uint8_t _data[4095] = {};
};

struct container {

	uint8_t type = 1;
	data n;

	static container make() {

		container ret;
		
        printf("Before: %d", (int)ret.type);
		ret.n = data{};
		printf("After: %d", (int)ret.type);

		return ret;
	}
	
	container() {}
	container(const container& o) {}
};

void func(container c) {}

void main() {
	func(container::make());
}
```
Which resulted in the following output when compiled via `cl bug.cpp -O2`:
```
Before: 1
After: 0
```

My example seemed wildly specific. In fact, each of the following changes would correct the output:
- Changing `_data[4095]` to `_data[4094]` or smaller
- Removing the container copy constructor
- Removing the call to `func()`
- Making an unrelated call to `container::make()` before `func()`

If you have any idea why this situation would trigger an interference bug, let me know!
